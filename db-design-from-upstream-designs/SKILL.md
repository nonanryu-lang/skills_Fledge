---
name: db-design-from-upstream-designs
description: 要件定義書・基本設計書・詳細設計書を入力として、実装可能なDB設計書（テーブル定義、制約、インデックス、トランザクション観点）を作成し、設計書内にMermaidのER図を出力するスキル。次の場面で使用する：(1) 上流設計からDB設計へ落とし込みたいとき、(2) 文書間の不整合を整理しながらデータモデルを確定したいとき、(3) DBレビュー用のER図をMarkdownに埋め込みたいとき、(4) 「DB設計書」「ER図」「Mermaid」「テーブル設計」「要件からDB設計」などのキーワードがあるとき。
---

# 上流設計→DB設計書作成スキル

要件定義書・基本設計書・詳細設計書を統合し、DB設計書を作成する。出力にはMermaid `erDiagram` を必ず含める。

## ワークフロー判定

入力状態に応じてフローを選ぶ：

- **新規作成フロー**: DB設計書が未作成で、上流文書から新規に作る
- **差分更新フロー**: 既存DB設計書に上流変更を反映する

## ステップ1: 入力資料と前提を確認する

最初に次を確認する：

1. 入力資料の有無（要件定義書、基本設計書、詳細設計書）
2. 対象範囲（業務ドメイン、対象機能、対象リリース）
3. 対象DB前提（RDB種別、命名規約、既存スキーマ有無）
4. 出力粒度（論理設計中心か、物理設計まで含むか）

不足がある場合は2〜3問ずつ追加ヒアリングする。矛盾がある場合は、詳細設計書 > 基本設計書 > 要件定義書の優先順位で採用し、設計判断として明示する。

## ステップ2: 上流情報をDB要素へマッピングする

マッピング基準は [references/source-to-db-mapping.md](references/source-to-db-mapping.md) を参照する。

実施内容：

1. エンティティ候補を抽出する
2. 属性・型・制約候補を抽出する
3. 主キー/外部キー/一意制約候補を特定する
4. トランザクション観点（更新順、排他、整合性）を抽出する
5. 性能観点（検索条件、集計条件、件数）からインデックス要件を抽出する

不明点は `[TBD]` として残し、確認質問を列挙する。

## ステップ3: DB設計書を作成する

テンプレートは [references/db-design-template.md](references/db-design-template.md) を使う。

作成ルール：

1. テーブルごとに「目的・主キー・外部キー・制約・インデックス」を明記する
2. カラムは論理名/物理名/型/NULL可否/既定値/制約/説明を記述する
3. 要件・基本設計・詳細設計とのトレーサビリティ表を含める
4. 未確定事項は `[TBD]` とし、影響範囲を添える
5. 出力ファイル名は `db-design-[プロジェクト名].md` とする

## ステップ4: Mermaid ER図を設計書に埋め込む

Mermaidルールは [references/mermaid-er-rules.md](references/mermaid-er-rules.md) を参照する。

必須ルール：

1. `erDiagram` 記法を使う
2. 全外部キーを関係線として表現する
3. 多対多は中間テーブルで解消した形で表現する
4. テーブル詳細の物理名・制約名と整合させる
5. 必要に応じてドメイン単位で図を分割する

出力時は、DB設計書本文の「ER図（Mermaid）」セクションにコードブロックで挿入する。

## ステップ5: 整合性を検証する

最低限、次を確認する：

1. 主要機能のCRUDがいずれかのテーブルで表現されている
2. 全FKがER図とテーブル詳細の両方に反映されている
3. 一意制約と業務重複禁止条件が一致している
4. 検索・一覧要件に対するインデックス方針がある
5. 監査・保持・削除要件が列設計と運用方針に反映されている

不足があれば「不足DB設計項目」として列挙し、追補案を提示する。

## ステップ6: 差分更新を反映する

差分更新フローでは次を実行する：

1. 変更された上流項目を抽出する（追加/変更/削除）
2. 影響テーブルと制約を特定する
3. ER図とテーブル詳細を同時更新する
4. 変更理由と影響範囲を変更履歴に記録する
5. 必要に応じて移行・互換性方針を追記する

## ステップ7: レビューして確定する

ユーザーへ以下を確認する：

1. 未確定 `[TBD]` の解消方針と期限
2. 優先レビュー対象（整合性/性能/運用）
3. 次工程（DDL作成、マイグレーション、実装）への受け渡し形式

レビュー反映後、最終版を出力する。
