# 設計→Dockerマッピング

## 1. 基本方針

- 設計上の責務単位をDockerサービスへ対応付ける
- 実行依存関係は `depends_on` とヘルスチェックで管理する
- 環境差分は `Dockerfile` ではなく `.env` と compose override で管理する

## 2. マッピング表

| 設計要素 | Docker成果物 | 決定ポイント |
| --- | --- | --- |
| 画面設計（SPA/SSR） | `web` サービス, `Dockerfile.web` | Nodeバージョン, 開発サーバーポート, ボリュームマウント |
| API設計 | `api` サービス, `Dockerfile.api` | 実行コマンド, 依存サービス, ヘルスチェックURL |
| バッチ/ワーカー設計 | `worker` サービス, `Dockerfile.worker` | スケジュール実行方式, 再起動ポリシー |
| データ設計 | `db` サービス, `init.sql` or migration command | DBバージョン, 永続ボリューム, 初期化方式 |
| キャッシュ設計 | `redis` 等のサービス | 永続化要否, メモリ制限 |
| メッセージング設計 | `rabbitmq` / `kafka` 等のサービス | トピック/キュー初期化, 管理ポート公開要否 |
| 非機能（監視/ログ） | logging設定, healthcheck | ログ粒度, 健全性判定条件 |
| セキュリティ要件 | `.env.example`, secret注入ルール | 秘密情報の保管先, 公開ポート最小化 |

## 3. ネットワーク設計ルール

- サービス間通信は内部ネットワークを優先する
- ホスト公開ポートは必要最小限に限定する
- 本番相当検証が必要な場合のみネットワーク分離を追加する

## 4. ボリューム設計ルール

- DBデータは命名済みボリュームで永続化する
- アプリの依存キャッシュ（例: `node_modules`）は用途に応じて分離する
- 一時ファイルは named volume か tmpfs を使い、不要に永続化しない

## 5. 差分更新ルール

- 変更対象を「イメージ」「起動コマンド」「設定値」「依存関係」に分解する
- DBの破壊的変更はロールバック案を必ず併記する
- 変更が横断的な場合は compose 全体整合を再確認する
